<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
  	<meta charset="utf-8">
  	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  	<title>Generic Covariance | Rezolver IOC </title>
  	<meta name="viewport" content="width=device-width">
  	<meta name="title" content="Generic Covariance | Rezolver IOC ">
  	<meta name="generator" content="docfx 2.40.10.0">
  	<meta name="description" content="Rezolver is the portable open-source IOC container framework for .Net - built from the ground up for .Net Core, Asp.Net Core, and also optimised for the 'full .Net' :)">
  	<link rel="shortcut icon" href="../../favicon.ico">
  	<link rel="stylesheet" href="../../styles/docfx.vendor.css">
  	<link rel="stylesheet" href="../../styles/docfx.css">
  	<link rel="stylesheet" href="../../styles/main.css">
  	<meta property="docfx:navrel" content="../../toc.html">
  	<meta property="docfx:tocrel" content="../toc.html">
  	
  	<meta property="docfx:rel" content="../../">
  	
  		<link rel="apple-touch-icon" sizes="57x57" href="../../../apple-touch-icon-57x57.png">
  		<link rel="apple-touch-icon" sizes="60x60" href="../../../apple-touch-icon-60x60.png">
  		<link rel="apple-touch-icon" sizes="72x72" href="../../../apple-touch-icon-72x72.png">
  		<link rel="apple-touch-icon" sizes="76x76" href="../../../apple-touch-icon-76x76.png">
  		<link rel="apple-touch-icon" sizes="114x114" href="../../../apple-touch-icon-114x114.png">
  		<link rel="apple-touch-icon" sizes="120x120" href="../../../apple-touch-icon-120x120.png">
  		<link rel="apple-touch-icon" sizes="144x144" href="../../../apple-touch-icon-144x144.png">
  		<link rel="apple-touch-icon" sizes="152x152" href="../../../apple-touch-icon-152x152.png">
  		<link rel="apple-touch-icon" sizes="180x180" href="../../../apple-touch-icon-180x180.png">
  		<link rel="icon" type="image/png" href="../../../favicon-32x32.png" sizes="32x32">
  		<link rel="icon" type="image/png" href="../../../android-chrome-192x192.png" sizes="192x192">
  		<link rel="icon" type="image/png" href="../../../favicon-96x96.png" sizes="96x96">
  		<link rel="icon" type="image/png" href="../../../favicon-16x16.png" sizes="16x16">
  		<link rel="manifest" href="../../../manifest.json">
  		<link rel="mask-icon" href="../../../safari-pinned-tab.svg" color="#5bbad5">
  		<meta name="msapplication-TileColor" content="#da532c">
  		<meta name="msapplication-TileImage" content="../../../mstile-144x144.png">
  		<meta name="theme-color" content="#ffffff">
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container-fluid">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../../images/rz_square_white_on_orange_48x48.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
        		<p class="navbar-text navbar-right github-link"><a href="http://github.com/ZolutionSoftware/Rezolver" target="_blank" title="See this project on Github"><span class="fa fa-github"></span></a></p>
        		<form class="navbar-form navbar-right" role="search" id="search">
        		<div class="form-group">
        			<input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
        		</div>
        		</form>
        		<p class="navbar-text navbar-right">
        			<a href="https://www.nuget.org/packages/Rezolver" target="_blank"><img src="//img.shields.io/nuget/v/Rezolver.svg?style=plastic&amp;maxage=480" title="Get the Nuget Package"></a>
        			<a href="http://waffle.io/ZolutionSoftware/Rezolver" title="Open the Waffleboard for this project" target="_blank"><img alt="Work in Progress" src="https://badge.waffle.io/ZolutionSoftware/Rezolver.png?label=in%20progress&title=In%20Progress"></a>
        			<!-- <a href="http://waffle.io/ZolutionSoftware/Rezolver" title="Open the Waffleboard for this project" target="_blank"><img alt="Work prepared" src="https://badge.waffle.io/ZolutionSoftware/Rezolver.png?label=ready&title=Ready"></img></a> -->
        		</p>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container-fluid hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container-fluid body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-9">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="generic-covariance">Generic Covariance</h1>

<p>v1.3.2 of Rezolver sees the introduction of generic covariance, which is a much more commonly used type of 
generic variance in .Net, compared to <a href="contravariance.html">contravariance</a>, however it&#39;s also more rare in 
the IOC world.</p>
<p>Generic covariance allows a variable of type <code>Generic&lt;Ta&gt;</code> to be assigned to an instance of <code>Generic&lt;Tb&gt;</code> 
so long as the type <code>Tb</code> is reference compatible with <code>Ta</code>.</p>
<div class="WARNING"><h5>Warning</h5><p>Note that this precludes <code>Ta</code> being <code>object</code> and <code>Tb</code> being
a <code>struct</code> (a value type), because assignment of a value type to <code>object</code> requires a boxing conversion.</p>
</div>
<p>Here are some examples:</p>
<pre><code class="lang-cs">Func&lt;object&gt; f1 
    = new Func&lt;string&gt;(() =&gt; &quot;Hello World&quot;);
Func&lt;IEnumerable&lt;object&gt; f2 
    = new Func&lt;IEnumerable&lt;string&gt;&gt;(() =&gt; new string[] { &quot;Hello World&quot; });
Func&lt;IEnumerable&lt;object&gt;&gt; f3 
    = new Func&lt;string[]&gt;(() =&gt; new string[] { &quot;Hello World&quot; });
</code></pre><p>The first assignment is allowed because <code>string</code> is a reference type which, of course, inherits from <code>object</code> - 
therefore an instance of <code>Func&lt;string&gt;</code> can be assigned to a <code>Func&lt;object&gt;</code> reference.</p>
<p>The second assignment is allowed because <code>IEnumerable&lt;out T&gt;</code> is also a covariant generic type, which means that
an instance of <code>IEnumerable&lt;string&gt;</code> can be assigned to an <code>IEnumerable&lt;object&gt;</code> reference; which therefore also
means that the two <code>Func&lt;out T&gt;</code> types are also reference compatible.</p>
<p>The third assignment is allowed because of array covariance (which is, admittedly, slightly broken in .Net).
Again, a <code>string[]</code> instance can be assigned to an <code>object[]</code> reference; and since <code>IEnumerable&lt;object&gt;</code> is 
then an implemented interface of <code>object[]</code>; it means they, too, are reference compatible.</p>
<h1 id="in-rezolver">In Rezolver</h1>
<p>Rezolver&#39;s implementation of covariance relies only on the declaration of covariant type parameters on generic
types which are registered as services.</p>
<p>So, consider this:</p>
<pre><code class="lang-cs">interface ICovariant&lt;out T&gt;
{
  T Foo();
}

class MyBase { }

class MyDerived { }

class ProducesMyDerived : ICovariant&lt;MyDerived&gt;
{
  MyDerived Foo()
  {
    //get a MyDerived object and return it.
  }
}
</code></pre><p>Given an <a class="xref" href="../../api/Rezolver.IContainer.html">IContainer</a> called <code>container</code>, we can now do this:</p>
<pre><code class="lang-cs">container.RegisterType&lt;ProducesMyDerived, ICovariant&lt;MyDerived&gt;();

var result = container.Resolve&lt;ICovariant&lt;MyBase&gt;&gt;();
</code></pre><p>Assuming no other registrations exist, <code>result</code> will be an instance of our <code>ProducesMyDerived</code> class in the
previous code block.</p>
<h2 id="last-registered-wins">Last-registered wins</h2>
<div class="NOTE"><h5>Note</h5><p>If a registration exists for the exact type requested, then covariance is ignored in favour of the 
most-recently registered exact match.</p>
</div>
<p>Just as with all other registrations (except <a href="contravariance.html">contravariance</a>), the registration that 
serves a request for a particular service type <em>which is matched covariantly</em> is the one that was registered 
most recently.</p>
<p>So a <code>Func&lt;MyBase&gt;</code> registration will supersede a <code>Func&lt;MyDerived&gt;</code> registration for a 
request for a <code>Func&lt;object&gt;</code> service if the <code>Func&lt;MyBase&gt;</code> registration was made last.</p>
<h1 id="examples">Examples</h1>
<h2 id="constant-funcout-t-service">Constant <code>Func&lt;out T&gt;</code> service</h2>
<p>Here&#39;s an example, in unit test form, similar to the type of covariance we&#39;ve just covered above, this time 
with delegates:</p>
<pre><code class="lang-csharp" name="CovarianceExamples.cs">var container = new Container();
container.RegisterObject&lt;Func&lt;MyService2&gt;&gt;(() =&gt; new MyService2());

var result = container.Resolve&lt;Func&lt;IMyService&gt;&gt;();

Assert.IsType&lt;Func&lt;MyService2&gt;&gt;(result);
</code></pre><div class="NOTE"><h5>Note</h5><p>Notice that with delegates, you typically register the delegate directly against its actual type - the 
&#39;service type&#39; for the registration is exactly the same as the delegate type itself.</p>
</div>
<h2 id="enumerables">Enumerables</h2>
<p>Single-service scenarios like the <code>MyBase</code>/<code>MyDerived</code> example above are less common with covariance in the 
IOC world.  The most common example is with <code>IEnumerable&lt;T&gt;</code> functionality - where an application has several 
registrations for concrete types which all happen to share a common base or interface, and your application 
wants to be able to resolve them all automatically by that base or interface whilst still also needing to 
be able to resolve them by their concrete types.</p>
<p>Clearly, without covariance, this could be achieved by creating two separate registrations for the same type - 
one against the concrete type and one against the common base/interface.</p>
<p>However, since <code>IEnumerable&lt;T&gt;</code> is covariant, any registration whose type is reference compatible with the <code>T</code>
really should be <em>automatically</em> identified and included in the enumerable.</p>
<p>Rezolver&#39;s automatic <a href="../enumerables.html">enumerable handling</a> supports this without any effort from you:</p>
<pre><code class="lang-csharp" name="CovarianceExamples.cs">var container = new Container();
container.RegisterType&lt;MyService1&gt;();
container.RegisterType&lt;MyService2&gt;();
container.RegisterType&lt;MyService3&gt;();

var result = container.ResolveMany&lt;IMyService&gt;();

Assert.Collection(result,
    new Action&lt;IMyService&gt;[]
    {
        s =&gt; Assert.IsType&lt;MyService1&gt;(s),
        s =&gt; Assert.IsType&lt;MyService2&gt;(s),
        s =&gt; Assert.IsType&lt;MyService3&gt;(s)
    });
</code></pre><h3 id="nested-generic-covariance">Nested Generic Covariance</h3>
<p>This can be extended even further when the element type of an enumerable is itself a generic which
contains one or more covariant type parameters.</p>
<p>This is similar to the above example, except this time we have a series of concrete <code>Func&lt;out T&gt;</code> registrations:</p>
<pre><code class="lang-csharp" name="CovarianceExamples.cs">var container = new Container();
container.RegisterObject&lt;Func&lt;MyService1&gt;&gt;(() =&gt; new MyService1());
container.RegisterObject&lt;Func&lt;MyService2&gt;&gt;(() =&gt; new MyService2());
container.RegisterObject&lt;Func&lt;MyService3&gt;&gt;(() =&gt; new MyService3());

var result = container.ResolveMany&lt;Func&lt;IMyService&gt;&gt;();

Assert.Collection(result,
    new Action&lt;Func&lt;IMyService&gt;&gt;[]
    {
        f =&gt; Assert.IsType&lt;Func&lt;MyService1&gt;&gt;(f),
        f =&gt; Assert.IsType&lt;Func&lt;MyService2&gt;&gt;(f),
        f =&gt; Assert.IsType&lt;Func&lt;MyService3&gt;&gt;(f)
    });
</code></pre><h3 id="nested-generic-contravariance">Nested Generic Contravariance</h3>
<p>You might be wondering why we&#39;d have an example about contravariance in the section about covariance - well
an enumerable of <code>Action&lt;T&gt;</code>, for example, can still match covariantly:</p>
<pre><code class="lang-csharp" name="CovarianceExamples.cs">var container = new Container();
container.RegisterObject&lt;Action&lt;IMyService&gt;&gt;(s =&gt; Console.WriteLine(&quot;interface&quot;));
container.RegisterObject&lt;Action&lt;object&gt;&gt;(s =&gt; Console.WriteLine(&quot;object&quot;));

var result = container.ResolveMany&lt;Action&lt;MyService&gt;&gt;();

Assert.Collection(result,
    new Action&lt;Action&lt;MyService&gt;&gt;[]{
        a =&gt; Assert.IsType&lt;Action&lt;IMyService&gt;&gt;(a),
        a =&gt; Assert.IsType&lt;Action&lt;object&gt;&gt;(a)
    });
</code></pre><div class="TIP"><h5>Tip</h5><p>When you start combining different types of variance you very quickly encounter counter-intuitive scenarios.
In this case, try not to be distracted by the fact that the types in the <code>Action&lt;&gt;</code> delegate appear to be
going the &#39;wrong way&#39; up or down a type hierarchy.</p>
<p>Remember that variance is all about <em><strong>reference-compatibility</strong></em>, not specifically about whether two types share
a common base or interface.  So, since an instance of <code>Action&lt;MyService&gt;</code> is reference compatible with a
variable of type <code>Action&lt;IMyService&gt;</code>, an <code>IEnumerable&lt;Action&lt;MyService&gt;&gt;</code> can also contain an
instance of <code>Action&lt;IMyService&gt;</code>.</p>
<hr>
<p>If you&#39;re already familiar with the term &#39;reference compatible&#39; then this will be of no surprise to you
after learning that Rezolver supports generic variance <span class="emoji" shortcode="wink">😉</span></p>
</div>
</article>
          </div>
          <div class="hidden-sm col-md-3" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/ZolutionSoftware/Rezolver/blob/autofactories/doc/Rezolver.Docs/_docfx_proj/docs/variance/covariance.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <span>Copyright &copy;2014 onwards <a href="http://www.zolution.co.uk" target="_blank">Zolution Software Ltd</a><br>Generated by <a href="https://dotnet.github.io/docfx/" target="_blank">DocFX</a>, with the Rezolver theme</span>
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
